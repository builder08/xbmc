# Default options: --with sound --with dlopen --with xscreensaver
#
# --without sound:  disables all sound support.
# --without dlopen: links with OpenAL and libvorbisfile at compile-time,
#                   rather than deferring it to run-time.
# --without xscreensaver:
#                   produce stand-alone programs only.
#
# This spec file can only be used with a modular, configurable XScreenSaver,
# which is pretty much only Fedora at the moment.

%{?_with_sound: %{?_without_sound:%{error:both '--with sound' and '--without sound' specified}}}
%{?_with_dlopen:%{?_without_sound:%{error:both '--with dlopen' and '--without dlopen' specified}}}
%{?_with_xscreensaver:%{?_without_xscreensaver:%{error:both '--with xscreensaver' and '--without xscreensaver' specified}}}

%{?_without_sound: %define _configure_sound --disable-sound}
%{!?_without_sound:%define _configure_sound --enable-sound%{!?_without_dlopen:=dlopen}}

# Sanity check: don't allow --with xscreensaver if xscreensaver wasn't
# around when rsxs.spec was generated by configure, because we really don't
# know where files are supposed to go...
%if 0%{!?_without_xscreensaver:1}
	%if "@XSCREENSAVER@" != "yes" || "@XSCREENSAVER_MODULAR@" != "yes" || "@XSCREENSAVER_CONFIGURABLE@" != "yes"
		%{error:spec file was not generated by ./configure --with-xscreensaver --with-moduledir --with-configdir}
	%else
		%define _use_xscreensaver 1
	%endif
%endif

%if 0%{?_use_xscreensaver}

	# Expand hackdir -- configure leaves this unexpanded so that
	# one could do "make install exec_prefix=..."
	%define _hackdir %(exec_prefix="%{_exec_prefix}"; echo "@hackdir@")

	%define _moduledir @moduledir@
	%define _configdir @configdir@
	%define __xscreensaver_command /usr/bin/xscreensaver-command
	%define __xscreensaver_updater @XSCREENSAVER_UPDATER@

	%define _configure_xscreensaver --with-xscreensaver --with-hackdir=%{_hackdir} --with-moduledir=%{_moduledir} --with-xscreensaver-updater=%{__xscreensaver_updater} --without-defaultdir --with-configdir=%{_configdir}

%else

	# Always use bindir here
	%define _hackdir %(exec_prefix="%{_exec_prefix}"; echo "@bindir@")

	%define _configure_xscreensaver --without-xscreensaver

%endif

%define _configure_opts %{_configure_sound} %{_configure_xscreensaver} --enable-image

Name: @PACKAGE_TARNAME@
Version: @PACKAGE_VERSION@
Release: @RELEASE@%{?dist}
License: GPL
Source0: @PACKAGE_TARNAME@-@PACKAGE_VERSION@.tar.gz
URL: http://rsxs.sourceforge.net/
BuildRoot: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXX)
BuildRequires: libSM-devel, libICE-devel, libXmu-devel, libXt-devel
BuildRequires: libGL-devel, libGLU-devel, libpng-devel
%{!?_without_sound:BuildRequires: openal-devel, libvorbis-devel}
Summary: @PACKAGE_NAME@
Group: Amusements/Graphics
%{?_use_xscreensaver:Requires: xscreensaver-base, xscreensaver-gl-base}
%{?_use_xscreensaver:Requires(post):   %{__xscreensaver_updater}}
%{?_use_xscreensaver:Requires(postun): %{__xscreensaver_updater}}
Obsoletes: @PACKAGE_TARNAME@-nosound
Provides: @PACKAGE_TARNAME@-nosound

%description
The @PACKAGE_NAME@ package is an X11/GLX port of the
Really Slick Screensavers collection, by Terry Welsh
(http://www.reallyslick.com).

%prep
%setup -q -n @PACKAGE_TARNAME@-@PACKAGE_VERSION@

%build
%{configure} %{_configure_opts}
%{__make}

%install
if test "$RPM_BUILD_ROOT" != "/"; then
	%{__rm} -rf $RPM_BUILD_ROOT
fi
%{makeinstall} \
	hackdir=$RPM_BUILD_ROOT%{_hackdir} \
	moduledir=$RPM_BUILD_ROOT%{_moduledir} \
	configdir=$RPM_BUILD_ROOT%{_configdir}

%clean
if test "$RPM_BUILD_ROOT" != "/"; then
	%{__rm} -rf $RPM_BUILD_ROOT
fi

%if 0%{?_use_xscreensaver}

%post
%{__xscreensaver_updater}
if %{__xscreensaver_command} -version &> /dev/null; then
	%{__xscreensaver_command} --restart &> /dev/null || :
fi

%postun
if test $1 -eq 0; then
	%{__xscreensaver_updater}
	if %{__xscreensaver_command} -version &> /dev/null; then
		%{__xscreensaver_command} --restart &> /dev/null || :
	fi
fi

%endif

%files
%defattr(-,root,root)
%doc AUTHORS COPYING ChangeLog INSTALL README THANKS
%{_hackdir}/rs-*
%if 0%{?_use_xscreensaver}
%{_configdir}/rs-*
%{_moduledir}/rs-*
%endif
%{_datadir}/@PACKAGE_TARNAME@

%changelog
@CHANGELOG@
